name: ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆCIï¼‰

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  frontend:
    name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆãƒ†ã‚¹ãƒˆãƒ»ãƒ“ãƒ«ãƒ‰ï¼‰
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci
    
    - name: ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
      run: npm test -- --coverage --watchAll=false
    
    - name: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
      run: npm run build
    
    - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/build/

  backend:
    name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆãƒ†ã‚¹ãƒˆãƒ»é™çš„è§£æï¼‰
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
          MYSQL_DATABASE: ticket_manager_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    defaults:
      run:
        working-directory: ./backend
    
    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: Rubyç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3.0'
        bundler-cache: true
        working-directory: ./backend
    
    - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      env:
        RAILS_ENV: test
        CI: true
        DATABASE_URL: mysql2://root@127.0.0.1:3306/ticket_manager_test
      run: |
        bundle exec rails db:create
        bundle exec rails db:migrate
    
    - name: ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
      env:
        RAILS_ENV: test
        CI: true
        DATABASE_URL: mysql2://root@127.0.0.1:3306/ticket_manager_test
      run: bundle exec rspec
    
    - name: RuboCopé™çš„è§£æã®å®Ÿè¡Œ
      run: bundle exec rubocop
    
    - name: Brakemanã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã®å®Ÿè¡Œ
      run: |
        echo "ğŸ” Brakemanã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œä¸­..."
        set +e  # ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®è‡ªå‹•çµ‚äº†ã‚’ç„¡åŠ¹åŒ–
        bundle exec brakeman --no-pager --format text
        BRAKEMAN_EXIT_CODE=$?
        set -e  # ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®è‡ªå‹•çµ‚äº†ã‚’å†æœ‰åŠ¹åŒ–
        
        if [ $BRAKEMAN_EXIT_CODE -eq 0 ]; then
          echo "âœ… Brakemanã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸ: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Šãªã—"
        elif [ $BRAKEMAN_EXIT_CODE -eq 3 ]; then
          echo "âš ï¸  Brakemanè­¦å‘ŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸãŒã€æ—¢çŸ¥ã®è­¦å‘Šã¨ã—ã¦ç¶™ç¶šã—ã¾ã™"
          echo "è­¦å‘Šã®è©³ç´°ã¯ä¸Šè¨˜ã®å‡ºåŠ›ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        else
          echo "âŒ Brakemanã‚¹ã‚­ãƒ£ãƒ³ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (çµ‚äº†ã‚³ãƒ¼ãƒ‰: $BRAKEMAN_EXIT_CODE)"
          exit $BRAKEMAN_EXIT_CODE
        fi
    
    - name: Swaggerãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
      env:
        RAILS_ENV: test
        CI: true
        DATABASE_URL: mysql2://root@127.0.0.1:3306/ticket_manager_test
      run: bundle exec rails rswag:specs:swaggerize

  integration:
    name: çµ±åˆãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    
    steps:
    - name: ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: ./frontend/build/
    
    - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®æ¤œè¨¼
      run: |
        echo "ğŸ“Š ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰ã‚µã‚¤ã‚º:"
        du -sh frontend/build/
        echo "ğŸ“‹ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰Swaggerãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:"
        ls -la backend/swagger/v1/ || echo "âš ï¸  Swaggerãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" 